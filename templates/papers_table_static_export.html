{% block papers_table_static_export %}
<tbody style="position: relative;">
<tr>
    <td style="padding:0;">
        <div class="loading-overlay">
            <div class="header-branding"><span>Research</span><span style="font-weight: 600; color: var(--primary-ui-color);">Par√ßa</span></div>
            <div class="loading-spinner"></div>
            <div>Reprocessing table. Wait patiently. </div>
        </div>
    </td>
</tr>
{% for paper in papers %}
    <tr data-paper-id="{{ paper.id }}" >
        {% if paper.pdf_filename %}
        <td class="status-cell pdf-status">
            {% if paper.pdf_state == 'annotated' %}
                <a href="data/pdf_annotated/{{ paper.pdf_filename }}" target="_blank" class="pdf-link" title="Open PDF">
                    {{ pdf_emojis.get(paper.pdf_state) }}
                </a>
            {% else %}
                <a href="data/pdf/{{ paper.pdf_filename }}" target="_blank" class="pdf-link" title="Open PDF">
                    {{ pdf_emojis.get(paper.pdf_state) }}
                </a>
            {% endif %}
        </td>
        {% else %}
        <td>
            {% if paper.pdf_state == 'paywalled' %}
                <span title="This paper is paywalled">
                    {{ pdf_emojis.get(paper.pdf_state) }}
                </span>
            </td>
            {% endif %}
        {% endif %}
        </td><td class="title-cell">
            {% if paper.doi %}
                <a href="https://doi.org/{{ paper.doi }}" target="_blank">{{ paper.title }}</a>
            {% else %}
                <span style="font-weight: 300;">{{paper.title}}</span> 
            {% endif %}
        </td>

        <td class="secondary-text-cell" data-field="authors">{{ paper.authors }}</td>
        <td class="secondary-text-cell number-cell">{{ paper.year or '' }}</td>
        <td class="secondary-text-cell number-cell">{{ paper.page_count or '' }}</td>
        <td class="secondary-text-cell">{{ paper.journal }}</td>        
        <td class="status-cell" title="{{ paper.type }}">{{ type_emojis.get(paper.type, default_type_emoji) }}
        
        <td class="status-cell editable-status" data-field="is_offtopic">{{ paper.is_offtopic | render_status }}</td>
        <td class="secondary-text-cell number-cell">{{ paper.relevance or '' }}</td>
        <td class="status-cell editable-status" data-field="is_survey">{{ paper.is_survey | render_status }}</td>

        <td class="secondary-text-cell changed-cell highlight-status">{{ paper.changed_formatted }}</td> <!-- Use formatted timestamp -->
        <td class="status-cell changed-by-cell highlight-status" data-field="changed_by">{{ paper.changed_by | render_changed_by }}</td>           
        <td class="status-cell editable-status" data-field="verified">{{ paper.verified | render_status }}</td>
        <td class="secondary-text-cell number-cell" data-field="verified">{{ paper.estimated_score  or '' }}</td>
        <td class="status-cell editable-verify" data-field="verified_by">{{ paper.verified_by | render_verified_by }}</td>                 
        <td class="status-cell" data-field="user_comment_state">{{ '‚úîÔ∏è' if paper.user_trace and (paper.user_trace|string).strip() else '‚ùå' }}</td> 
        <td class="toggle-btn" onclick="toggleDetails(this)"><span>Show</span></td>
        
        <!-- Hidden data cells for faster stats retrieval -->
        <td class="hidden-data-cell" data-field="abstract" style="display: none;">{{ paper.abstract }}</td>
        <td class="hidden-data-cell" data-field="keywords" style="display: none;">{{ paper.keywords }}</td>
        <td class="hidden-data-cell" data-field="user_trace" style="display: none;">{{ paper.user_trace or '' }}</td>
        <td class="hidden-data-cell" data-field="research_area" style="display: none;">{{ paper.research_area or '' }}</td>
    </tr>

    <tr class="detail-row">
        <td colspan="17">
            <div class="detail-flex-container">
                <div class="detail-content detail-abstract">
                    <div class="id-section">
                        <strong>ID:</strong> {{ paper.id }} 
                        <button type="button" class="id-copy-btn" onclick="copyPaperId('{{ paper.id }}', this)">Copy</button>
                    </div>
                    <!-- <strong>Type:</strong> {{ paper.type }}</p> -->
                    <p><strong>Abstract:</strong> {{ paper.abstract }}</p>
                </div>

                <div class="detail-content detail-metadata">
                    
                    <div class="bibtex-section">
                        <strong>BibTeX Citation:</strong> 
                        <button type="button" class="bibtex-copy-btn" onclick="copyBibtex(`{{ paper | bibtex }}`, this)">Copy</button>
                        <pre class="bibtex-pre">{{ paper | bibtex }}</pre>
                    </div>

                    <div class="searchable-section">
                        <span style="font-size:0.8em; color: var(--light-colored-btn-text);">Click on any keyword or author below to <strong>search</strong> for it:</span>
                        <p><strong>Keywords:</strong>
                            <span class="clickable-keywords">
                                {% if paper.keywords %}
                                    {% set keywords_list = paper.keywords.split(';') %}
                                    {% for keyword in keywords_list %}
                                        {% set trimmed_keyword = keyword.strip() %}
                                        {% if trimmed_keyword %}
                                            <span class="clickable-item" data-search-field="keywords" data-search-term="{{ trimmed_keyword }}">{{ trimmed_keyword }};<!--üîç--></span>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    {{ paper.keywords }} <!-- In case it's empty or None -->
                                {% endif %}
                            </span>
                        </p>
                        <p><strong>Authors:</strong>
                            <span class="clickable-authors">
                                {% if paper.authors %}
                                    {% set authors_list = paper.authors.split(';') %}
                                    {% for author in authors_list %}
                                        {% set trimmed_author = author.strip() %}
                                        {% if trimmed_author %}
                                            <span class="clickable-item" data-search-field="authors" data-search-term="{{ trimmed_author }}">{{ trimmed_author }};<!--üîç--></span>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    {{ paper.authors }} <!-- In case it's empty or None -->
                                {% endif %}
                            </span>
                        </p>
                    </div>
                    <p>
                        <strong>DOI:</strong>
                            {% if paper.doi %}
                                <a href="https://doi.org/{{ paper.doi }}" target="_blank">{{ paper.doi }}</a>
                            {% else %}
                                {{ paper.doi }}
                            {% endif %}
                        <br>
                        <strong> ISSN:</strong>             
                            {% if paper.issn %}
                                {{ paper.issn }}
                            {% else %}
                                None
                            {% endif %}
                        <strong> ‚Äî Page Range/Start:</strong> {{ paper.pages }}
                    </p>
                </div>
                <div class="edit-section detail-edit">
                    <form id="form-{{ paper.id }}" data-paper-id="{{ paper.id }}">
                        <label>Research Area:
                            <input type="text" class="editable" name="research_area" value="{{ paper.research_area or '' }}">
                        </label>
                        <label>Page count:
                            <input type="text" class="editable" name="page_count" value="{{ paper.page_count or '' }}">
                        </label>
                        <label>Relevance:
                            <input type="text" class="editable" name="relevance" value="{{ paper.relevance or '' }}" placeholder="0 - 10">
                        </label>
                        <label>User comments:
                            <textarea class="editable" name="user_trace">{{ paper.user_trace or '' }}</textarea>
                        </label>
                        <!-- NEW: Per-Row Action Buttons -->
                        <div class="row-actions">
                            <button type="button" class="action-btn del-btn" onclick="deletePaper('{{ paper.id }}')"><strong>Delete</strong> Record</button>
                            <button type="button" class="action-btn save-btn" onclick="saveChanges('{{ paper.id }}')">Save Changes</button>
                        </div>
                        
                    </form>
                </div>
            </div>
        </td>
    </tr>
{% endfor %}
</tbody>
{% endblock %}